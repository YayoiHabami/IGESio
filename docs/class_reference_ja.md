# クラス構造

## 目次

- [目次](#目次)
- [中間生成物](#中間生成物)
- [IEntity継承クラス](#ientity継承クラス)
  - [IEntityクラス](#ientityクラス)
  - [その他の非個別エンティティクラス](#その他の非個別エンティティクラス)
- [その他非エンティティクラス](#その他非エンティティクラス)
- [設計意図](#設計意図)
  - [IEntityクラスの設計意図](#ientityクラスの設計意図)
    - [DEパラメータの分類と設計](#deパラメータの分類と設計)

## 中間生成物

　IGESファイルを読み込んだ場合、内部的に、以下のクラスインスタンスを最初に作成します。

| クラス名 | 中間生成物 | 説明 |
| --- | :-: | --- |
| `std::string` | No | IGESファイルのStartセクションの文字列 |
| `models::GlobalParam` | No | IGESファイル全体のGlobalセクションのパラメータを保持するクラス |
| `entities::RawEntityDE` | Yes | IGESファイルのDirectory Entryセクションの各レコードをそのまま保持するクラス |
| `entities::RawEntityPD` | Yes | IGESファイルのParameter Dataセクションの各レコードをそのまま保持するクラス |

　次に、`GlobalParam`および中間生成物を用いて、[各エンティティクラス](#ientity継承クラス)（`IEntity`を継承するクラス）を生成します。中間生成物から

> 実際には、`IgesData`クラスのコンストラクタにて、IGESファイルのパスを指定して読み込むことを想定します。一応、ユーザーがIGESファイルの情報をほぼそのまま使用可能なように、各中間生成物を戻り値とする関数を公開部分に含めています（`ReadIgesIntermediate`等）。ただ、本ライブラリにおけるIGESファイルの読み込み処理は、基本的に`IgesData`クラスに隠蔽するため、ユーザーが直接中間生成物を操作することは想定していません。
>
> 実際にユーザーが使用することを想定している`IgesData`クラスを戻り値とする関数は`igesio::ReadIges`としていて、上記の中間生成物を含む4つの変数を返す`igesio::ReadIgesIntermediate`関数とは区別しています。また、`IgesData`のコンストラクタは、上述のファイルパスを渡すものだけではなく、`GlobalParam`と中間生成物を渡すものも用意します。

## IEntity継承クラス

### IEntityクラス

　本ライブラリでは、IGESファイルの各エンティティを表現するために、`IEntity`という抽象クラスを定義し、これを継承した具体的なエンティティクラスを実装しています。IGESにおいては、まずエンティティはエンティティタイプとフォーム番号によって機能が決定されます。これらの情報を、各エンティティの`GetType`メソッドと`GetFormNumber`メソッドから取得できるように、`IEntity`クラスに定義しています。

　また、CADデータにおいて、各エンティティは親子関係を持つことができます。IGESファイルでは、DEポインタ<sup>※</sup>を用いてエンティティを一意に管理しますから、親要素が子要素のDEポインタを指示することで親子関係を表現できます。しかし、このDEポインタは、IGESファイル内において、そのエンティティが何行目に記述されたかに依存するため、エンティティの追加や削除が行われうるプログラム上では、DEポインタを直接使用することはできません。

そこで、本ライブラリでは、エンティティのインスタンスを作成する際に、`uint64_t`型のIDを割り当て、これを用いてエンティティを一意に識別します。エンティティのインスタンスを作成する際にこのIDの数値は自動的に割り当てられ、割り当てられた値は`GetID`メソッドから取得できます。また、各エンティティの親子関係に関する情報を取得する`std::shared_ptr<const IEntity> GetEntity`メソッドや`std::vector<uint64_t> GetChildIDs`メソッドも定義しています。これらのメソッドにおいては、具体的なエンティティを指定する/示すために、DEポインタではなく、（`uint64_t`型の）IDを使用します。

> ※**DEポインタ**：IGESファイルにおいて、エンティティのデータはDirectory EntryセクションとParameter Dataセクションに分かれて格納されます。また、IGESファイルの各行はシーケンス番号と呼ばれる番号を持ち、DEセクションのデータレコードのシーケンス番号を用いて、IGESファイル内のエンティティを一意に識別します。このシーケンス番号を指すポインタをDEポインタと呼びます。DEポインタは、物理的な関係に限らず、論理的な関係も含め、親子関係を表現するために使用されます。

### その他の非個別エンティティクラス

　本ライブラリでは、個別のエンティティクラスの実装に先立ち、抽象的な処理を定義するいくつかのクラスを定義しています。

| クラス名 | 親クラス | 説明 |
| --- | --- | --- |
| `IEntity` | - | 全てのエンティティクラスが継承する抽象クラス<br>エンティティのタイプ等を取得するメソッドや、直接の子要素のIDを取得するメソッド、DEパラメータを取得するメソッドなど、全てのエンティティが共通して持つ機能を定義<br><br>`EntityBase`クラスがCRTP（Curiously Recurring Template Pattern）を使用するため、全エンティティを一種類のポインタで扱えるように型消去を行う |
| `EntityBase` | `IEntity` | 全てのエンティティクラスが継承する抽象クラス<br>メンバ変数や、一部のメソッドの実装を提供する |

## その他非エンティティクラス

| パス | クラス名 | 説明 |
| --- | --- | --- |
| `igesio/common/matrix.h` | `Matrix2d`, `Matrix23d`, `Matrix32d`, `Matrix3d`, `Matrix2Xd`, `Matrix3Xd`, `Vector2d`, `Vector3d` | 固定サイズおよび動的サイズの行列クラス<br>詳細は[こちら](./common/matrix_ja.md) |

## 設計意図

### IEntityクラスの設計意図

　まず、すべてのエンティティが備えるべき機能

- エンティティを区別するための情報の取得
  - Entity type, form number, id (instead of DE pointer)
  - クラス（IGES）、サブクラス（自作、粒度大きめ）
- 依存（親子）関係を規定する情報
  - 子要素のポインタ
  - DependencyStatus (⇒ 全てのDEパラメータに含まれる)
- すべてのエンティティが共通して持つ情報の取得
  - [すべてのDEパラメータ](#deパラメータの分類と設計)
  - 合わせて、親から子要素に変換行列を伝播させる機能（親に変換行列の参照を追加する方法、親とすべての子要素の座標に変換をかける方法などがある。親が変換行列の参照を持てない場合や、子が2Dの場合はどうするか）
    - 行列を右から掛けるメソッド（インスタンス自身の座標を変更する非constメソッド）
    - 行列との演算子オーバーロード（座標値を変更したコピーを作成するconstメソッド）。こちらについて、子要素はstd::shared_ptr<const IEntity>であるが、どうするのか（子要素もコピーして座標値を変更するか？この場合、const IEntityのポインタを持つもの以外に所有権を持つものがいなくなるという問題がある。もしくは、この演算を物理的な子要素を持たないものに限定するか？その場合、それを確認するためのメソッドをIEntityに実装する）
      - Section 3.2.2を読む限り、Table 4に示される関係以外は、親の変換行列が適用されることはないように思える。とりあえずその方向性で実装を進めるか。

#### DEパラメータの分類と設計

　本ライブラリでは、20種類のDEパラメータを以下に示す5つのグループに分類しています。以下の表では、例えば「Entity Type (1, 11)」は、ディレクトリエントリセクションのパラメータ1と11の「Entity Type Number」を指します。

- 個別のクラスを作成する必要のないもの (列挙体やプリミティブ型を使用するもの)
  - Entity Type (1, 11), Status Number (9), Line Weight (12), Form Number (15), Entity Label (18), Entity Subscript Number (19)
- 個別のクラスを作成する必要のあるもの
  - 無効値 (0) か単一種類のエンティティへのポインタ (負値) のみを持つもの
    - Structure (3), Transformation Matrix (7), Label Display Assoc. (8)
  - 規定値 (正値) か無効値 (0)、もしくは単一種類のエンティティへのポインタ (負値) を持つもの
    - 正値が列挙体: Line Font Pattern (4), Color (13)
    - 正値が任意値: Level (5)
  - 無効値 (0) か複数種類のエンティティへのポインタ (負値) を持つもの
    - View (6)
- `IEntity`のインスタンス上で意味を持たないもの
  - Parameter Data (2), Sequence Number (10, 20), Parameter Line Count (14), Reserved (16, 17)
