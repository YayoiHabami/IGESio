# クラス構造

## 目次

- [目次](#目次)
- [中間生成物](#中間生成物)
- [IEntity継承クラス](#ientity継承クラス)
  - [IEntityクラス](#ientityクラス)
  - [その他の非個別エンティティクラス](#その他の非個別エンティティクラス)
- [その他非エンティティクラス](#その他非エンティティクラス)

## 中間生成物

　IGESファイルを読み込んだ場合、内部的に、以下のクラスインスタンスを最初に作成します。

| クラス名 | 中間生成物 | 説明 |
| --- | :-: | --- |
| `std::string` | No | IGESファイルのStartセクションの文字列 |
| `models::GlobalParam` | No | IGESファイル全体のGlobalセクションのパラメータを保持するクラス |
| `entities::RawEntityDE` | Yes | IGESファイルのDirectory Entryセクションの各レコードをそのまま保持するクラス |
| `entities::RawEntityPD` | Yes | IGESファイルのParameter Dataセクションの各レコードをそのまま保持するクラス |

　次に、`GlobalParam`および中間生成物を用いて、[各エンティティクラス](#ientity継承クラス)（`IEntity`を継承するクラス）を生成します。中間生成物から

> 実際には、`IgesData`クラスのコンストラクタにて、IGESファイルのパスを指定して読み込むことを想定します。一応、ユーザーがIGESファイルの情報をほぼそのまま使用可能なように、各中間生成物を戻り値とする関数を公開部分に含めています（`ReadIgesIntermediate`等）。ただ、本ライブラリにおけるIGESファイルの読み込み処理は、基本的に`IgesData`クラスに隠蔽するため、ユーザーが直接中間生成物を操作することは想定していません。
>
> 実際にユーザーが使用することを想定している`IgesData`クラスを戻り値とする関数は`igesio::ReadIges`としていて、上記の中間生成物を含む4つの変数を返す`igesio::ReadIgesIntermediate`関数とは区別しています。また、`IgesData`のコンストラクタは、上述のファイルパスを渡すものだけではなく、`GlobalParam`と中間生成物を渡すものも用意します。

## IEntity継承クラス

### IEntityクラス

　本ライブラリでは、IGESファイルの各エンティティを表現するために、`IEntity`という抽象クラスを定義し、これを継承した具体的なエンティティクラスを実装しています。IGESにおいては、まずエンティティはエンティティタイプとフォーム番号によって機能が決定されます。これらの情報を、各エンティティの`GetType`メンバ関数と`GetFormNumber`メンバ関数から取得できるように、`IEntity`クラスに定義しています。

　また、CADデータにおいて、各エンティティは親子関係を持つことができます。IGESファイルでは、DEポインタ<sup>※</sup>を用いてエンティティを一意に管理しますから、親要素が子要素のDEポインタを指示することで親子関係を表現できます。しかし、このDEポインタは、IGESファイル内において、そのエンティティが何行目に記述されたかに依存するため、エンティティの追加や削除が行われうるプログラム上では、DEポインタを直接使用することはできません。

そこで、本ライブラリでは、エンティティのインスタンスを作成する際に、`uint64_t`型のIDを割り当て、これを用いてエンティティを一意に識別します。エンティティのインスタンスを作成する際にこのIDの数値は自動的に割り当てられ、割り当てられた値は`GetID`メンバ関数から取得できます。また、各エンティティの親子関係に関する情報を取得する`std::shared_ptr<const IEntity> GetEntity`メンバ関数や`std::vector<uint64_t> GetChildIDs`メンバ関数も定義しています。これらのメンバ関数においては、具体的なエンティティを指定する/示すために、DEポインタではなく、（`uint64_t`型の）IDを使用します。

> ※**DEポインタ**：IGESファイルにおいて、エンティティのデータはDirectory EntryセクションとParameter Dataセクションに分かれて格納されます。また、IGESファイルの各行はシーケンス番号と呼ばれる番号を持ち、DEセクションのデータレコードのシーケンス番号を用いて、IGESファイル内のエンティティを一意に識別します。このシーケンス番号を指すポインタをDEポインタと呼びます。DEポインタは、物理的な関係に限らず、論理的な関係も含め、親子関係を表現するために使用されます。

### その他の非個別エンティティクラス

　本ライブラリでは、個別のエンティティクラスの実装に先立ち、抽象的な処理を定義するいくつかのクラスを定義しています。

| クラス名 | 親クラス | 説明 |
| --- | --- | --- |
| `IEntity` | - | 全てのエンティティクラスが継承する抽象クラス<br>エンティティのタイプ等を取得するメンバ関数や、直接の子要素のIDを取得するメンバ関数、DEパラメータを取得するメンバ関数など、全てのエンティティが共通して持つ機能を定義<br><br>`EntityBase`クラスがCRTP（Curiously Recurring Template Pattern）を使用するため、全エンティティを一種類のポインタで扱えるように型消去を行う |
| `EntityBase` | `IEntity` | 全てのエンティティクラスが継承する抽象クラス<br>メンバ変数や、一部のメンバ関数の実装を提供する |

## その他非エンティティクラス

| パス | クラス名 | 説明 |
| --- | --- | --- |
| `igesio/common/matrix.h` | `Matrix2d`, `Matrix23d`, `Matrix32d`, `Matrix3d`, `Matrix2Xd`, `Matrix3Xd`, `Vector2d`, `Vector3d` | 固定サイズおよび動的サイズの行列クラス<br>詳細は[こちら](./common/matrix_ja.md) |
