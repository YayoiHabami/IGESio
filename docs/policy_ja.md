# 方針

　以下の方針は、IGES 5.3の仕様書に基づくものです。本ライブラリの実装に際して、以下に示す方針に従うようにします。

　すべてのセクションにおいて、末尾の`(Section X.Y.Z)`は、その記述のソースとなるIGES 5.3の仕様書のセクション番号を示します。

## 目次

- [目次](#目次)
- [ライブラリ全体に関するTODO](#ライブラリ全体に関するtodo)
- [データ型](#データ型)
- [エンティティ](#エンティティ)
  - [モデルの情報構造の概念](#モデルの情報構造の概念)
    - [従属状態 (Subordinate Entity Switch)](#従属状態-subordinate-entity-switch)
    - [ディレクトリエントリセクションにおける指定](#ディレクトリエントリセクションにおける指定)
  - [座標系と変換行列](#座標系と変換行列)
    - [座標系](#座標系)
    - [変換行列の適用](#変換行列の適用)

## ライブラリ全体に関するTODO

　以下のTODOは、本ライブラリをIGES 5.3に準拠させるために必要な事項（の一部）です。現時点では、以下のTODOは未実装/未対応です。

- [ ] 不正なレコード構造を持つか、本仕様書で定義されたデータを含まないために処理出来ない場合、エラーメッセージを発効する必要がある (Section 1.4.7)。
- [ ] ライブラリは、ユーザが編集しなかったエンティティに影響を与えてはならない (Section 1.4.7.1)。ただし、これはポインタ、行番号、エンティティ数などの、他のエンティティを編集した際に更新される情報を除く。

## データ型

　IGES 5.3では、フィールド値に対して6種類のデータ型が定義されています (Section 2.2.2)。

| データ型 | 説明 |
| :---: | :--- |
| 整数<br>(固定小数点値) | 絶対値が $2^{N-1} - 1$ を越えない範囲の、正、負、ゼロの値をとる整数値。ここで、$N$ はグローバルパラメータ7で定義されるビット数。<br> 例) `1` `150` `2147483647` `+3451` `0` `-10` `-2147483647` |
| 実数<br>(浮動小数点値) | `[<符号>]<整数部>.<小数部>[<指数部>]`の形式で表される実数値。整数部と小数部は、どちらか一方のみであれば省略可能である。指数部は、`E`または`D`の後に整数値を続けることで表され、前者が単精度、後者が倍精度を表す。単精度の場合はグローバルセクション8～9で、倍精度の場合はグローバルセクション10～11で定義される値を越えてはならない。<br> 例) `1.0` `-0.0001` `+3.14159E+2` `-2.71828D-1` `.15` `-1.E+3` |
| 文字列 | 制御文字 (`\x00`～`\x1F`) を除くASCII文字の並び。冒頭に文字列全体の文字数を`<文字数>H`の形式で付加する。<br> 例) `5HHello` `3HHi!` `10HABC ., ; A` |
| ポインタデータ | $-9999999$ から $9999999$ の範囲の整数値。ディレクトリエントリまたはパラメータデータセクションにおける74～80文字目の値を指す。負値の場合はその絶対値が行番号を指し、ゼロ値を持つポインタはヌルポインタを表す。|
| 言語<br>ステートメント | `<文字数>H`を含まない、制御文字 (`\x00`～`\x1F`) を除くASCII文字の並び。|
| 論理データ | 論理データ型は「TRUE」と「FALSE」の2つの値のみを持つ。符号なし整数0はFALSEを表し、符号なし整数1はTRUEを表す。|

そのほか以下の指令に従います。

- 空白は文字列と言語ステートメントにおいてのみ値となり、それ以外のデータ型ではデフォルト値として扱われる。
- 数値フィールドの先頭の空白は無視する。また、グローバルセクション1に関わらず、数値内に`,`を含めてはならない。

## エンティティ

　ファイル内で、データの基本単位はエンティティであり、**幾何学的エンティティ**と**非幾何学的エンティティ**に分類されます (Section 1.5)。

- 幾何学的エンティティ：製品の物理的形状を定義
- 非幾何学的エンティティ：注釈、定義、構造の指定など、主に表示メカニズムに関連する情報を定義

### モデルの情報構造の概念

　製品の幾何学的モデルは、一般的に互いに独立して定義されるため、以下に示すエンティティがそれらの関係を補強します (Section 1.6)。

**表**. 情報構造を定義するエンティティ. "エンティティ番号"列の名前は、全て"Entity"を省略しています (e.g. "Property Entity (Type 406)" -> "Property (406)")。

| タイプ | エンティティ番号 | 説明 |
|:---:|:---:|:---|
| プロパティ | Property<br>(406) | 非幾何学的数値・テキストを、それを参照するエンティティに関連付ける。レベル番号による関連付けも存在 (後述)。 |
| 関連性 | Associativity<br>Definition (302)<br>Group Associativity (402) | 複数のエンティティを互いに関連づける。 |
| ビュー | View (410)<br>View Visible<br>Associativity<br>(402, Form 3,4,19) | 幾何学的モデルの選択されたサブセットの2次元投影を描画する。 |
| 図面 | Drawing (404) | 人間の表示のための、ビューと注釈の組み合わせ。 |
| 変換行列 | Transformation<br>Matrix<br>(124) | 任意のエンティティに適用される、平行移動と回転を定義する。 |
| 実装者定義 | - | 実装者が定義したエンティティ。 |

> レベル番号による関連付け：
>
> プロパティエンティティが指定されていない場合には、プロパティエンティティのレベル番号を共有するすべてのエンティティが、そのプロパティを参照します (Section 1.6.1)。

#### 従属状態 (Subordinate Entity Switch)

　IGES 5.3では、エンティティの従属状態 (ファイル内の他のエンティティにより参照されるかどうか) を、ディレクトリエントリセクションの9番目のフィールド（1行目、67～68文字目）で指定します。エンティティの従属状態は以下の4つの値のいずれかです (Section 2.2.4.4)。

| 値 | タイプ | 説明 |
|:---:|:---:|:---|
| `00` | Independent | エンティティは単独で存在し、他のエンティティから参照されない。 |
| `01` | Physically<br>Dependent | エンティティは他のエンティティから参照され、そのエンティティの変換 (行列) を継承する。 |
| `02` | Logically<br>Dependent | エンティティは単独で存在できるが、他のエンティティと合わせてグループ化される。 |
| `03` | Both<br>Dependencies | Physically DependentとLogically Dependentの両方の状態を持つ。 |

　エンティティAがエンティティBに従属するのは、エンティティBのパラメータデータエントリにおいて、エンティティAを参照する場合のみとなります。各エンティティのエントリの後に付加される追加ポインタ（バックポインタ; Section 2.2.4.5.2）は、この定義の目的では無視されます。

#### ディレクトリエントリセクションにおける指定

　ディレクトリエントリセクションにおいては、以下のポインタが定義されます (Section 2.2.4.4)。

**表**. ディレクトリエントリセクションにおいて定義されるポインタ. `L1C3`は、そのエンティティに関する1行目の17～24文字目の数値を指します。

| 位置 | フィールド名 | 説明 |
|:---:|:---:|:---|
| `L1C2` | Parameter<br>Data | (1) このエンティティの最初のパラメータデータレコードのシーケンス番号<br>(2) または0 |
| `L1C3` | Structure | (1) 負値の場合、その絶対値はスキーマを指定する構造定義エンティティを参照する<br>(2) または0<br>※このフィールドは、以下のエンティティタイプでのみ負値を取る:<br>  - Macro Instance (UNTESTED; 600-699, 10000-99999)<br>  - Associativity Instance (402, Forms 5001-9999)<br>Attribute Table Instance (422, Forms 0-1) |
| `L1C4` | Line<br>Font<br>Pattern | (1) 0以上の値は、後述する線種パターンを使用して表示する<br>(2) 負値の場合、その絶対値は線種パターンを定義するLine Font Definition (304)を参照する |
| `L1C5` | Level | (1) 正値の場合、このエンティティに関連付けられるレベル番号を示す<br>(2) 負値の場合、その絶対値はレベル番号を定義するDefinition Levels Property (460, Form 1)を参照する<br>(3) または0 (デフォルト) |
| `L1C6` | View | (1)0の場合、 エンティティは全てのビューで可視であり、かつ表示特性が同じである<br>(2) 正値の場合、その値は以下のどちらかのエンティティを参照する<br>  - View (402): エンティティが1つのビューでのみ可視である場合<br>  - Views Visible Associativity (402, Form 3,4,19): それ以外の場合、特に表示特性が全てのビューで同じでない場合、Form 4または19を使用する |
| `L1C7` | Transformation<br>Matrix | (1) 正値の場合、Transformation Matrix (124)を参照する<br>(2) 0の場合、無変換 (単位回転行列とゼロ変換ベクトル) を意味する |
| `L1C8` | Label<br>Display<br>Assoc. | (1) 正値の場合、Label Display Associativity (402, Form 5) を参照する<br>(2) 0の場合は参照しない |
| `L2C3` | Color<br>Number | (1) 0以上の値は、後述する色番号を使用して表示する<br>(2) 負値の場合、その絶対値はColor Definition (314)を参照する |

> 線種パターン：
> | 値 | パターン |
> |:---:|:---:|
> | 0 | パターン未指定 (デフォルト) |
> | 1 | 実線 |
> | 2 | 破線 |
> | 3 | ファントム線 |
> | 4 | 中心線 |
> | 5 | 点線 |

> 色番号：
> | 値 | 色 |
> |:---:|:---:|
> | 0 | 色未指定 (デフォルト) |
> | 1 | 黒 |
> | 2 | 赤 |
> | 3 | 緑 |
> | 4 | 青 |
> | 5 | 黄 |
> | 6 | マゼンタ |
> | 7 | シアン |
> | 8 | 白 |

### 座標系と変換行列

#### 座標系

　IGES 5.3においては、2種類の座標系が定義されています (Section 3.2.2)。一つ目が、ファイル毎に1つのみ定義される**モデル空間** (model space) $(X,Y,Z)$ であり、もう一つは、エンティティごとに定義される（または定義されうる）**定義空間** (definition space) $(X_T, Y_T, Z_T)$ です。

| 座標系 | 説明 |
| --- | --- |
| モデル空間<br> $(X, Y, Z)$ | 　表現される「モデル」（または製品）が配置される、右手系の直交座標系であり、モデルに対して固定されている。 |
| 定義空間<br> $(X_T, Y_T, Z_T)$ | 　エンティティごとに存在する (可能性のある) 右手系の直交座標系である。原点はモデル空間内の任意の位置に配置され、また向きも任意である。ただし、長さの単位はモデル空間と同じである。<br> 　幾何エンティティが単一平面内に含まれる場合、基本的には $Z_T = 0$ の平面に配置される。 |

#### 変換行列の適用

　子は自身の定義空間で形状を定義するため、親の定義空間と子の定義空間が異なる場合、親の定義空間での表現を得るために回転・平行移動を行う必要があります。この変換を行う回転行列・平行移動ベクトルを定義する目的で、各エンティティはDEフィールド7でTransformation Matrix (Type 124)を参照することができます。

　エンティティが変換行列を参照する場合、そのエンティティの実際の位置（もしくは親の定義空間における位置）は、子の定義空間における位置に同時変換行列を掛けたものになります。また、以下のように、参照する変換行列 ($M_1$) が同様に別の変換行列 ($M_2$) を参照することもあります。それぞれ同時変換行列とし、エンティティXXXを構成する点を $\bm{p}_i = [x_i, y_i, z_i, 1]^\top$ とすると、以下の式で変換後の座標を得ることができます。

$$\bm{p}_i' = M_2 M_1 \bm{p}_i$$

```mermaid
flowchart TD
    subgraph Case1["Explicit Case"]
        direction LR
        C1["Child Entity<br>(Entity XXX)"] -->|DE Field 7| M1["Transformation<br>Matrix 1<br>(Form 124)"] -->|DE Field 7| M2["Transformation<br>Matrix 2<br>(Form 124)"]
    end
```

**Figure** Explicit Case (See Section 3.2.3)

　一方で、一部のケース (**implicit case**) では、親の変換行列が子に伝播されることがあります (Section 3.2.3)。以下の図のように、エンティティXXXが、エンティティYYYに物理的に従属していて、それぞれDEフィールド7で変換行列 $M_2$, $M_1$ を参照している場合を考えます。この場合、エンティティXXXを構成する点を $\bm{p}_i = [x_i, y_i, z_i, 1]^\top$ とすると、以下の式で変換後の座標を得ることができます。

$$\bm{p}_i' = M_1 M_2 \bm{p}_i$$

```mermaid
flowchart TD
    subgraph Case2["Parent-Child Implicit Case"]
        direction LR
        P1["Parent Entity<br>(Entity YYY)"] -->|DE Field 7| M3["Transformation<br>Matrix 1<br>(Form 124)"]
        P1 -->|Physically<br>Dependent| C2["Child Entity<br>(Entity XXX)"] -->|DE Field 7| M4["Transformation<br>Matrix 2<br>(Form 124)"]
    end
```

**Figure** Parent-Child Implicit Case (See Section 3.2.3)

　したがって、あるエンティティの位置を考える上で、その親との関係がimplicit caseであるかそうでないかを考慮する必要があります。

　implicit caseの具体的な例については、[Entity Classification Table](./entity_analysis.md/#entity-classification-table)を参照してください。
